#!/usr/bin/env bash

# Ensure a plugin package is good for publishing.
#
# Usage:
#
#     $0 PACKAGE [-S "lint"|"test"|"build"[, -S ...]]
#
# This script will perform the following:
#
#   - install NPM packages and make sure they're up to date
#   - (optional, -S lint to skip) lint the back-end and UI sources
#   - (optional, -S test to skip) run the back-end tests
#   - (optional, -S build to skip) compile the plugin's UI assets
#
# Environment variables:
#
#   - PACKAGE: the package, in case $1 is not passed

[ -f "./package.json" ] && grep '"name": "megadoc"' ./package.json &> /dev/null || {
  echo "$0: Must be run from megadoc root.";
  exit 1
}

source "bin/_helpers.sh"

if [ -z $PACKAGE ]; then
  if [ $# -gt 0 ]; then
    PACKAGE=$1
    shift
  fi

  if [ -z $PACKAGE ]; then
    echo "Usage: $0 PACKAGE"
    exit 1
  fi
fi

PACKAGE_NAME="${PACKAGE}"
PACKAGE_ROOT="packages/${PACKAGE_NAME}"
PROVIDED_UI_LIBRARIES="react"
IGNORED=()

if [ ! -d "${PACKAGE_ROOT}" ]; then
  PACKAGE_NAME="megadoc-plugin-${PACKAGE}"
  PACKAGE_ROOT="packages/${PACKAGE_NAME}"

  if [ ! -d "${PACKAGE_ROOT}" ]; then
    echo "${PACKAGE_NAME} is not a valid megadoc plugin package."
    exit 1
  fi
fi

function link_local_dependencies {
  [ -f $PACKAGE_ROOT/package.json ] && {
    cd $PACKAGE_ROOT

    DEPS=$(node -e '
      console.log(Object.keys(require("./package").dependencies || {})
        .filter(function(x) { return x.match(/^megadoc/) })
        .join("\n")
      )
    ')

    PEER_DEPS=$(node -e '
      console.log(Object.keys(require("./package").peerDependencies || {})
        .filter(function(x) { return x.match(/^megadoc/) })
        .join("\n")
      )
    ')

    for dep in $DEPS; do
      echo "Linking local version of '${dep}'..."
      npm link --ignore-scripts "../${dep}"
    done

    for dep in $PEER_DEPS; do
      echo "Linking local version of '${dep}'..."
      npm link --ignore-scripts "../${dep}"
    done
  }
}

function ensure_no_unlisted_dependencies {
  [ -f $PACKAGE_ROOT/package.json ] && {
    out=$(./node_modules/.bin/depcheck $PACKAGE_ROOT --ignore-dirs="__tests__,ui" --json)

    # for some reason the --ignores flag is, well, being ignored by depcheck
    # so we resort to doing this manually in JS land:
    node -e "
      var IGNORED = [ 'multiline-slash' ];
      var deps = JSON.parse(process.argv[1]);
      var missingDeps = Object.keys(deps.missing || {})
        .filter(function(x) {
          return IGNORED.indexOf(x) === -1;
        })
      ;

      if (missingDeps.length > 0) {
        console.error('Missing dependencies:', missingDeps.map(function(x) { return '\n  * ' + x; }).join(''));
        process.exit(1);
      }
    " "${out}"

    return $?
  }
}

function refresh_dependencies {
  [ -f $PACKAGE_ROOT/package.json ] && {
    cd $PACKAGE_ROOT
    echo "Ensuring dependencies are not out-of-date..."

    npm install --ignore-scripts && {
      # this is causing issues on travis, i think it's the dedupe...
      if [ -z $TRAVIS_BUILD ]; then
        echo "Pruning and deduping..."
        npm prune && npm dedupe
      fi

      if [ "${PRELINK}" == "1" ]; then
        npm link --ignore-scripts
      fi
    }
  }
}

function lint_sources {
  ./bin/lint $PACKAGE
}

function lint_ui_sources {
  ./bin/lint-ui $PACKAGE
}

function run_tests {
  ./bin/test $PACKAGE --reporter dot
}

function build_assets {
  if [ ! -f $PACKAGE_ROOT/ui/index.js ]; then
    echo "Package has no UI assets to compile - nothing to do!"
    return 0
  fi

  if [ -d $PACKAGE_ROOT/dist ]; then
    echo "Cleaning previous build artifacts..."
    rm -r $PACKAGE_ROOT/dist
  fi

  ./cli/megadoc-compile --optimize \
    "${PACKAGE_ROOT}/dist/${PACKAGE_NAME}.js" \
    "${PACKAGE_ROOT}/ui/index.js"
}

echo "Preparing \"${PACKAGE_NAME}\" for publishing... hang on tight."
echo "---------------------------------------------------------------"

while getopts ":S:" opt; do
  case $opt in
    S)
      IGNORED+=("${OPTARG}")
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

function shouldRun() {
  if [[ " ${IGNORED[@]} " =~ " $1 " ]]; then
    return 1
  else
    return 0
  fi
}

if [ "${PRELINK}" == "1" ]; then
  run_task link_local_dependencies
fi

shouldRun "check" && run_task ensure_no_unlisted_dependencies
shouldRun "update" && run_task refresh_dependencies
shouldRun "lint" && run_task lint_sources && run_task lint_ui_sources
shouldRun "test" && run_task run_tests
shouldRun "build" && run_task build_assets

echo "Package \"${PACKAGE_NAME}\" is good for publishing, nice work!"
echo "---------------------------------------------------------------"
